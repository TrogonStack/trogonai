version: "3.9"

# Slack integration stack
# Required env vars (copy .env.example → .env):
#   SLACK_BOT_TOKEN   xoxb-...
#   SLACK_APP_TOKEN   xapp-...
#   ANTHROPIC_API_KEY sk-ant-...   (required by llm-anthropic; omit if using a different LLM)
#
# LLM provider selection:
#   LLM_PROVIDER   anthropic (default) | openai | gemini | deepseek
#
#   To use a non-default provider, set LLM_PROVIDER and start the matching worker:
#     docker compose --profile openai    up   (requires OPENAI_API_KEY)
#     docker compose --profile gemini    up   (requires GEMINI_API_KEY)
#     docker compose --profile deepseek  up   (requires DEEPSEEK_API_KEY)
#
# Optional env vars:
#   SLACK_BOT_USER_ID              UXXXXXXXX  (filters bot's own messages; auto-detected)
#   SLACK_MENTION_GATING           false      (respond to all channel messages; default: true)
#   SLACK_MENTION_GATING_CHANNELS  C123,C456  (channels where mention-gating is enforced)
#   SLACK_NO_MENTION_CHANNELS      C123,C456  (channels where bot responds without mention)
#   SLACK_ALLOW_BOTS               false      (allow bot messages to trigger the bot; default: false)
#   SLACK_SIGNING_SECRET           abc123     (Slack signing secret for Events API verification)
#   SLACK_EVENTS_PORT              3001       (port for the Events API HTTP listener; default: 3001)
#   SLACK_API_RPS                  1.0        (Slack API requests-per-second limit; default: 1.0)
#   SLACK_REPLY_TO_MODE            off | first | all  (default: off)
#   SLACK_REPLY_TO_MODE_DM         off | first | all  (overrides SLACK_REPLY_TO_MODE for DMs)
#   SLACK_REPLY_TO_MODE_GROUP      off | first | all  (overrides SLACK_REPLY_TO_MODE for group DMs)
#   SLACK_ACK_REACTION             eyes       (emoji added while processing; default: none)
#   SLACK_DM_POLICY                open       (who can DM the bot: open | disabled; default: open)
#   SLACK_CHANNEL_ALLOWLIST        C123,C456  (channels the bot will respond in; empty = all)
#   SLACK_WELCOME_MESSAGE          "Hi!"      (message sent when a user opens a DM for the first time)
#   SLACK_USER_RATE_LIMIT          0          (max requests per user per minute; 0 = unlimited)
#   SLACK_USER_ALLOWLIST           U123,U456  (users allowed to interact; empty = all)
#   SLACK_USER_BLOCKLIST           U123,U456  (users blocked from interacting; empty = none)
#   SLACK_DEBOUNCE_MS              0          (debounce window in ms; 0 = disabled)
#   SLACK_REACTION_NOTIFICATIONS   false      (acknowledge reactions; default: false)
#   SLACK_SEED_HISTORY_ON_START    0          (messages to fetch on session start; 0 = disabled)
#   SLACK_NO_TYPING_CHANNELS       C123,C456  (channels where typing indicator is suppressed)
#   SLACK_DM_PAIR_CHANNEL          C123       (channel to pair with DM sessions)
#   SLACK_SUGGESTED_PROMPTS        "Title:Message,Title2:Message2"  (suggested prompts for UI)
#   THREAD_INITIAL_HISTORY_LIMIT   0          (messages fetched from thread on first reply; 0 = none)
#   CLAUDE_MODEL                   claude-sonnet-4-6  (model sent in LLM requests; default)
#   CLAUDE_MAX_TOKENS              8192       (default)
#   CLAUDE_SYSTEM_PROMPT           "You are a helpful assistant."
#   CLAUDE_SYSTEM_PROMPT_FILE      /run/secrets/prompt.txt  (takes precedence over inline)
#   CLAUDE_RETRY_ATTEMPTS          3          (retry attempts on transient errors)
#   CLAUDE_MAX_HISTORY             40         (messages kept in KV; default)
#   CLAUDE_MAX_HISTORY_CHARS       0          (max total chars kept in history; 0 = unlimited)
#   SLACK_MAX_CONCURRENT_SESSIONS  0          (concurrent LLM API calls; 0 = unlimited)
#   SLACK_UPLOAD_THRESHOLD_CHARS   3000       (upload as file if longer than this)
#   CHANNEL_SYSTEM_PROMPTS         "C123=prompt,C456=other prompt"  (per-channel overrides)
#   NATS_TOKEN                                (NATS authentication token)
#   NATS_CREDS                                (path to NATS credentials file)
#   RUST_LOG                       info | debug | trace
#
# LLM worker env vars (per provider):
#   ANTHROPIC_DEFAULT_MODEL        claude-sonnet-4-6  (worker default; overridden per-request by CLAUDE_MODEL)
#   ANTHROPIC_DEFAULT_MAX_TOKENS   8192
#   ANTHROPIC_RETRY_ATTEMPTS       3
#   OPENAI_API_KEY                 sk-...
#   OPENAI_DEFAULT_MODEL           gpt-4o
#   OPENAI_DEFAULT_MAX_TOKENS      8192
#   OPENAI_RETRY_ATTEMPTS          3
#   GEMINI_API_KEY                 AIza...
#   GEMINI_DEFAULT_MODEL           gemini-2.0-flash
#   GEMINI_DEFAULT_MAX_TOKENS      8192
#   GEMINI_RETRY_ATTEMPTS          3
#   DEEPSEEK_API_KEY               sk-...
#   DEEPSEEK_DEFAULT_MODEL         deepseek-chat
#   DEEPSEEK_DEFAULT_MAX_TOKENS    8192
#   DEEPSEEK_RETRY_ATTEMPTS        3

services:
  nats:
    image: nats:2.10-alpine
    command: ["-js", "--store_dir=/data"]
    ports:
      - "4222:4222"
      - "8222:8222"   # monitoring HTTP endpoint
    volumes:
      - nats-data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8222/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5

  slack-bot:
    build:
      context: .
      dockerfile: crates/slack-bot/Dockerfile
    environment:
      SLACK_BOT_TOKEN: ${SLACK_BOT_TOKEN}
      SLACK_APP_TOKEN: ${SLACK_APP_TOKEN}
      SLACK_BOT_USER_ID: ${SLACK_BOT_USER_ID:-}
      SLACK_MENTION_GATING: ${SLACK_MENTION_GATING:-true}
      SLACK_MENTION_GATING_CHANNELS: ${SLACK_MENTION_GATING_CHANNELS:-}
      SLACK_NO_MENTION_CHANNELS: ${SLACK_NO_MENTION_CHANNELS:-}
      SLACK_ALLOW_BOTS: ${SLACK_ALLOW_BOTS:-false}
      SLACK_SIGNING_SECRET: ${SLACK_SIGNING_SECRET:-}
      SLACK_EVENTS_PORT: ${SLACK_EVENTS_PORT:-3001}
      SLACK_API_RPS: ${SLACK_API_RPS:-1.0}
      SLACK_MEDIA_MAX_MB: ${SLACK_MEDIA_MAX_MB:-20}
      SLACK_MENTION_PATTERNS: ${SLACK_MENTION_PATTERNS:-}
      SLACK_TEXT_CHUNK_LIMIT: ${SLACK_TEXT_CHUNK_LIMIT:-4000}
      SLACK_CHUNK_MODE: ${SLACK_CHUNK_MODE:-chars}
      SLACK_USER_TOKEN: ${SLACK_USER_TOKEN:-}
      HEALTH_PORT: 8080
      NATS_URL: nats://nats:4222
      NATS_TOKEN: ${NATS_TOKEN:-}
      NATS_CREDS: ${NATS_CREDS:-}
      RUST_LOG: ${RUST_LOG:-info}
    ports:
      - "8080:8080"
      - "${SLACK_EVENTS_PORT:-3001}:${SLACK_EVENTS_PORT:-3001}"
    depends_on:
      nats:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 15s
      timeout: 5s
      retries: 3

  slack-agent:
    build:
      context: .
      dockerfile: crates/slack-agent/Dockerfile
    environment:
      NATS_URL: nats://nats:4222
      NATS_TOKEN: ${NATS_TOKEN:-}
      NATS_CREDS: ${NATS_CREDS:-}
      LLM_PROVIDER: ${LLM_PROVIDER:-anthropic}
      SLACK_REPLY_TO_MODE: ${SLACK_REPLY_TO_MODE:-off}
      SLACK_REPLY_TO_MODE_DM: ${SLACK_REPLY_TO_MODE_DM:-}
      SLACK_REPLY_TO_MODE_GROUP: ${SLACK_REPLY_TO_MODE_GROUP:-}
      SLACK_REPLY_TO_MODE_CHANNEL: ${SLACK_REPLY_TO_MODE_CHANNEL:-}
      SLACK_ACK_REACTION: ${SLACK_ACK_REACTION:-}
      SLACK_DM_POLICY: ${SLACK_DM_POLICY:-open}
      SLACK_CHANNEL_ALLOWLIST: ${SLACK_CHANNEL_ALLOWLIST:-}
      SLACK_USER_ALLOWLIST: ${SLACK_USER_ALLOWLIST:-}
      SLACK_USER_BLOCKLIST: ${SLACK_USER_BLOCKLIST:-}
      SLACK_WELCOME_MESSAGE: ${SLACK_WELCOME_MESSAGE:-}
      SLACK_ALLOW_BOTS: ${SLACK_ALLOW_BOTS:-false}
      SLACK_USER_RATE_LIMIT: ${SLACK_USER_RATE_LIMIT:-0}
      SLACK_DEBOUNCE_MS: ${SLACK_DEBOUNCE_MS:-0}
      SLACK_REACTION_NOTIFICATIONS: ${SLACK_REACTION_NOTIFICATIONS:-false}
      SLACK_MAX_CONCURRENT_SESSIONS: ${SLACK_MAX_CONCURRENT_SESSIONS:-0}
      SLACK_UPLOAD_THRESHOLD_CHARS: ${SLACK_UPLOAD_THRESHOLD_CHARS:-0}
      SLACK_SEED_HISTORY_ON_START: ${SLACK_SEED_HISTORY_ON_START:-0}
      SLACK_NO_TYPING_CHANNELS: ${SLACK_NO_TYPING_CHANNELS:-}
      SLACK_DM_PAIR_CHANNEL: ${SLACK_DM_PAIR_CHANNEL:-}
      SLACK_SUGGESTED_PROMPTS: ${SLACK_SUGGESTED_PROMPTS:-}
      SLACK_STREAM_MODE: ${SLACK_STREAM_MODE:-partial}
      SLACK_REQUIRE_MENTION: ${SLACK_REQUIRE_MENTION:-false}
      SLACK_DM_SCOPE: ${SLACK_DM_SCOPE:-}
      SLACK_HISTORY_SCOPE: ${SLACK_HISTORY_SCOPE:-}
      SLACK_INHERIT_PARENT: ${SLACK_INHERIT_PARENT:-false}
      SLACK_SLASH_COMMAND_NAME: ${SLACK_SLASH_COMMAND_NAME:-}
      SLACK_SLASH_COMMAND_EPHEMERAL: ${SLACK_SLASH_COMMAND_EPHEMERAL:-true}
      SLACK_SLASH_COMMAND_OPTIONS: ${SLACK_SLASH_COMMAND_OPTIONS:-}
      CHANNEL_SYSTEM_PROMPTS: ${CHANNEL_SYSTEM_PROMPTS:-}
      CHANNEL_USER_ALLOWLISTS: ${CHANNEL_USER_ALLOWLISTS:-}
      CHANNEL_ACK_REACTIONS: ${CHANNEL_ACK_REACTIONS:-}
      THREAD_INITIAL_HISTORY_LIMIT: ${THREAD_INITIAL_HISTORY_LIMIT:-0}
      CLAUDE_MODEL: ${CLAUDE_MODEL:-claude-sonnet-4-6}
      CLAUDE_MAX_TOKENS: ${CLAUDE_MAX_TOKENS:-8192}
      CLAUDE_SYSTEM_PROMPT: ${CLAUDE_SYSTEM_PROMPT:-}
      CLAUDE_SYSTEM_PROMPT_FILE: ${CLAUDE_SYSTEM_PROMPT_FILE:-}
      CLAUDE_RETRY_ATTEMPTS: ${CLAUDE_RETRY_ATTEMPTS:-3}
      CLAUDE_MAX_HISTORY: ${CLAUDE_MAX_HISTORY:-40}
      CLAUDE_MAX_HISTORY_CHARS: ${CLAUDE_MAX_HISTORY_CHARS:-0}
      HEALTH_PORT: 8081
      RUST_LOG: ${RUST_LOG:-info}
    ports:
      - "8081:8081"
    depends_on:
      nats:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8081/health"]
      interval: 15s
      timeout: 5s
      retries: 3

  # ── LLM workers ───────────────────────────────────────────────────────────────
  # llm-anthropic is the default provider and starts with the base stack.
  # Other providers are opt-in via --profile.

  llm-anthropic:
    build:
      context: .
      dockerfile: crates/llm-anthropic/Dockerfile
    environment:
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      ANTHROPIC_DEFAULT_MODEL: ${ANTHROPIC_DEFAULT_MODEL:-claude-sonnet-4-6}
      ANTHROPIC_DEFAULT_MAX_TOKENS: ${ANTHROPIC_DEFAULT_MAX_TOKENS:-8192}
      ANTHROPIC_RETRY_ATTEMPTS: ${ANTHROPIC_RETRY_ATTEMPTS:-3}
      ACCOUNT_ID: ${SLACK_ACCOUNT_ID:-}
      NATS_URL: nats://nats:4222
      NATS_TOKEN: ${NATS_TOKEN:-}
      NATS_CREDS: ${NATS_CREDS:-}
      RUST_LOG: ${RUST_LOG:-info}
    depends_on:
      nats:
        condition: service_healthy
    restart: unless-stopped

  llm-openai:
    build:
      context: .
      dockerfile: crates/llm-openai/Dockerfile
    profiles: [openai]
    environment:
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_DEFAULT_MODEL: ${OPENAI_DEFAULT_MODEL:-gpt-4o}
      OPENAI_DEFAULT_MAX_TOKENS: ${OPENAI_DEFAULT_MAX_TOKENS:-8192}
      OPENAI_RETRY_ATTEMPTS: ${OPENAI_RETRY_ATTEMPTS:-3}
      ACCOUNT_ID: ${SLACK_ACCOUNT_ID:-}
      NATS_URL: nats://nats:4222
      NATS_TOKEN: ${NATS_TOKEN:-}
      NATS_CREDS: ${NATS_CREDS:-}
      RUST_LOG: ${RUST_LOG:-info}
    depends_on:
      nats:
        condition: service_healthy
    restart: unless-stopped

  llm-gemini:
    build:
      context: .
      dockerfile: crates/llm-gemini/Dockerfile
    profiles: [gemini]
    environment:
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      GEMINI_DEFAULT_MODEL: ${GEMINI_DEFAULT_MODEL:-gemini-2.0-flash}
      GEMINI_DEFAULT_MAX_TOKENS: ${GEMINI_DEFAULT_MAX_TOKENS:-8192}
      GEMINI_RETRY_ATTEMPTS: ${GEMINI_RETRY_ATTEMPTS:-3}
      ACCOUNT_ID: ${SLACK_ACCOUNT_ID:-}
      NATS_URL: nats://nats:4222
      NATS_TOKEN: ${NATS_TOKEN:-}
      NATS_CREDS: ${NATS_CREDS:-}
      RUST_LOG: ${RUST_LOG:-info}
    depends_on:
      nats:
        condition: service_healthy
    restart: unless-stopped

  llm-deepseek:
    build:
      context: .
      dockerfile: crates/llm-deepseek/Dockerfile
    profiles: [deepseek]
    environment:
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY}
      DEEPSEEK_DEFAULT_MODEL: ${DEEPSEEK_DEFAULT_MODEL:-deepseek-chat}
      DEEPSEEK_DEFAULT_MAX_TOKENS: ${DEEPSEEK_DEFAULT_MAX_TOKENS:-8192}
      DEEPSEEK_RETRY_ATTEMPTS: ${DEEPSEEK_RETRY_ATTEMPTS:-3}
      ACCOUNT_ID: ${SLACK_ACCOUNT_ID:-}
      NATS_URL: nats://nats:4222
      NATS_TOKEN: ${NATS_TOKEN:-}
      NATS_CREDS: ${NATS_CREDS:-}
      RUST_LOG: ${RUST_LOG:-info}
    depends_on:
      nats:
        condition: service_healthy
    restart: unless-stopped

volumes:
  nats-data:
